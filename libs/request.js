"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");exports.__esModule=!0,exports.Request=void 0;var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_extends2=_interopRequireDefault(require("@babel/runtime/helpers/extends")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_axios=_interopRequireDefault(require("axios")),https=_interopRequireWildcard(require("https")),_constants=require("../constants"),_convertValues=require("../utils/convertValues"),_debounce=require("../utils/debounce"),_throttle=require("../utils/throttle");function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!=key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}var Request=function(){function Request(hostname,_temp){var _ref=void 0===_temp?{}:_temp,_ref$headers=_ref.headers,headers=void 0===_ref$headers?_constants.AUTH_HEADERS:_ref$headers,_ref$response_type=_ref.response_type,response_type=void 0===_ref$response_type?_constants.REQUEST_RESPONSE_TYPE:_ref$response_type,_ref$request_timeout=_ref.request_timeout,request_timeout=void 0===_ref$request_timeout?_constants.REQUEST_TIMEOUT:_ref$request_timeout,_ref$request_throttle=_ref.request_throttle_interval,request_throttle_interval=void 0===_ref$request_throttle?_constants.REQUEST_THROTTLE_INTERVAL:_ref$request_throttle,_ref$request_debounce=_ref.request_debounce_interval,request_debounce_interval=void 0===_ref$request_debounce?_constants.REQUEST_DEBOUNCE_INTERVAL:_ref$request_debounce,_ref$request_concurre=_ref.request_concurrency,request_concurrency=void 0===_ref$request_concurre?_constants.REQUEST_CONCURRENCY:_ref$request_concurre;this.hostname=hostname,this.response_type=response_type,this.headers=headers,this.pending_requests=_constants.REQUEST_PENDING_COUNT,this.request_timeout=request_timeout,this.request_throttle_interval=request_throttle_interval,this.request_debounce_interval=request_debounce_interval,this.request_concurrency=request_concurrency}var _proto=Request.prototype;return _proto.run=function(){function run(){return _run.apply(this,arguments)}var _run=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(_ref2){var _ref2$url,url,_ref2$method,method,_ref2$body,body,_ref2$headers,headers,reporter,updatedMethod,config,RequestAxiosInstance,results,_results,_this=this;return _regenerator.default.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:_ref2$url=_ref2.url,url=void 0===_ref2$url?null:_ref2$url,_ref2$method=_ref2.method,method=void 0===_ref2$method?null:_ref2$method,_ref2$body=_ref2.body,body=void 0===_ref2$body?null:_ref2$body,_ref2$headers=_ref2.headers,headers=void 0===_ref2$headers?null:_ref2$headers,reporter=_ref2.reporter,updatedMethod=(0,_convertValues.convertStringToLowercase)(method),config={baseURL:this.hostname,headers:(0,_extends2.default)({},this.headers,headers),responseType:this.response_type,timeout:this.request_timeout,httpsAgent:new https.Agent({keepAlive:!0})},RequestAxiosInstance=_axios.default.create(config),RequestAxiosInstance.interceptors.request.use(function(config){var debounceInterval=(0,_debounce.debounce)(function(){return _this.pending_requests--},_this.request_debounce_interval),throttleInterval=(0,_throttle.throttle)(function(){return clearInterval(throttleInterval),debounceInterval(),config},_this.request_throttle_interval);return _this.pending_requests<=_this.request_concurrency&&throttleInterval(),_this.pending_requests>_this.request_concurrency&&reporter.warn("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - (THROTTLED) ("+_this.pending_requests+" pending "+(1<_this.pending_requests?"requests":"request")+")"),_this.pending_requests++,config}),function(res){return reporter.info("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - ("+(null===res||void 0===res?void 0:res.status)+" "+(null===res||void 0===res?void 0:res.statusText)+")"),res},function(err){return reporter.error("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - (ERROR)"),reporter.error("\n",""+((null===err||void 0===err?void 0:err.message)||(0,_convertValues.convertObjectToString)(err)||"An error occurred. Please try again later."),"\n"),err},RequestAxiosInstance.interceptors.response.use(function(res){return _this.pending_requests=Math.max(0,0<_this.pending_requests?_this.pending_requests-1:0),reporter.info("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - ("+(null===res||void 0===res?void 0:res.status)+" "+(null===res||void 0===res?void 0:res.statusText)+") - ("+_this.pending_requests+" pending "+(1<_this.pending_requests||0===_this.pending_requests?"requests":"request")+")"),res}),function(err){return err.response?(_this.pending_requests=Math.max(0,0<_this.pending_requests?_this.pending_requests-1:0),reporter.error("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - ("+err.response.status+" "+err.response.statusText+")"),reporter.error("\n",""+((null===err||void 0===err?void 0:err.message)||(0,_convertValues.convertObjectToString)(err)||"An error occurred. Please try again later."),"\n")):err.request?(_this.pending_requests=Math.max(0,0<_this.pending_requests?_this.pending_requests-1:0),reporter.error("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - ("+err.request.status+" "+err.request.statusText+")"),reporter.error("\n",""+((null===err||void 0===err?void 0:err.message)||(0,_convertValues.convertObjectToString)(err)||"An error occurred. Please try again later."),"\n")):(reporter.error("["+(0,_convertValues.convertStringToUppercase)(method)+"] "+(_constants.REQUEST_BIGCOMMERCE_API_URL+url)+" - (ERROR)"),reporter.error("\n",""+((null===err||void 0===err?void 0:err.message)||(0,_convertValues.convertObjectToString)(err)||"An error occurred. Please try again later."),"\n")),err},_context.t0=updatedMethod,_context.next="get"===_context.t0?9:"post"===_context.t0?13:17;break;case 9:return _context.next=11,RequestAxiosInstance.get(url,body).then(function(res){return res}).catch(function(err){return err});case 11:return results=_context.sent,_context.abrupt("return",results);case 13:return _context.next=15,RequestAxiosInstance.post(url,body).then(function(res){return res}).catch(function(err){return err});case 15:return _results=_context.sent,_context.abrupt("return",_results);case 17:throw new Error("The "+updatedMethod+" method is currently not supported.");case 18:case"end":return _context.stop();}},_callee,this)}));return run}(),Request}();exports.Request=Request;
//# sourceMappingURL=request.js.map